function AB2S(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;e<d;e++)b+=String.fromCharCode(c[e]);return b}function Mosquitto(){this.ws=null,this.onconnect=null,this.ondisconnect=null,this.onmessage=null}var CONNECT=16,CONNACK=32,PUBLISH=48,PUBACK=64,PUBREC=80,PUBREL=96,PUBCOMP=112,SUBSCRIBE=128,SUBACK=144,UNSUBSCRIBE=160,UNSUBACK=176,PINGREQ=192,PINGRESP=208,DISCONNECT=224;Mosquitto.prototype={mqtt_ping:function(){var a=new ArrayBuffer(2),b=new Int8Array(a);b[0]=PINGREQ,b[1]=0,1==this.ws.readyState?this.ws.send(a):this.queue(a)},connect:function(a,b){this.url=a,this.keepalive=b,this.mid=1,this.out_queue=new Array,this.ws=new WebSocket(a,"mqttv3.1"),this.ws.binaryType="arraybuffer",this.ws.onopen=this.ws_onopen,this.ws.onclose=this.ws_onclose,this.ws.onmessage=this.ws_onmessage,this.ws.m=this,this.ws.onerror=function(a){alert(a.data)}},disconnect:function(){if(1==this.ws.readyState){var a=new ArrayBuffer(2),b=new Int8Array(a);b[0]=DISCONNECT,b[1]=0,this.ws.send(a),this.ws.close()}},ws_onopen:function(a){var b=new ArrayBuffer(36),c=new Int8Array(b);i=0,c[i++]=CONNECT,c[i++]=34,c[i++]=0,c[i++]=6,e="MQIsdp";for(var d=0;d<e.length;d++)c[i++]=e.charCodeAt(d);c[i++]=3,c[i++]=2,c[i++]=0,c[i++]=255,c[i++]=0,c[i++]=20;for(var e="mjsws/",d=0;d<e.length;d++)c[i++]=e.charCodeAt(d);for(var f="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",d=0;d<14;d++)c[i++]=f.charCodeAt(Math.floor(Math.random()*f.length));for(this.send(b);this.m.out_queue.length>0;)this.send(this.m.out_queue.pop())},ws_onclose:function(a){this.m.ondisconnect&&this.m.ondisconnect(a.data)},ws_onmessage:function(a){var b=new Int8Array(a.data);buffer=a.data;for(var c=0;b.length>0&&c<1e3;)switch(c++,240&b[0]){case CONNACK:var d=b[1],e=b[2];this.m.onconnect&&this.m.onconnect(e),buffer=buffer.slice(d+2),b=new Int8Array(buffer);break;case PUBLISH:var i,f=1,g=1,d=0,h=0,j=(6&b[0])>>1,k=1&b[0],l=0;do h++,i=b[f++],d+=(127&i)*g,g*=128;while(0!=(128&i));var m=256*b[f++]+b[f++],n=buffer.slice(f,f+m);f+=m;var o=AB2S(n);j>0&&(l=256*b[f++]+b[f++]);var p=buffer.slice(f,d+h+1),q=AB2S(p);buffer=buffer.slice(d+1+h),b=new Int8Array(buffer),this.m.onmessage&&this.m.onmessage(o,q,j,k);break;case PUBREC:case PUBREL:case PUBACK:case PUBCOMP:case SUBACK:case UNSUBACK:case PINGRESP:var d=b[1];buffer=buffer.slice(d+2),b=new Int8Array(buffer)}},get_remaining_count:function(a){return a>=0&&a<128?1:a>=128&&a<16384?2:a>=16384&&a<2097152?3:a>=2097152&&a<268435456?4:-1},generate_mid:function(){var a=this.mid;return this.mid++,256==this.mid&&(this.mid=0),a},queue:function(a){this.out_queue.push(a)},send_cmd_with_mid:function(a,b){var c=new ArrayBuffer(4),d=new Int8Array(c);d[0]=a,d[1]=2,d[2]=b%128,d[3]=b/128,1==this.ws.readyState?this.ws.send(c):this.queue(c)},unsubscribe:function(a){var b=4+a.length,c=this.get_remaining_count(b),d=new ArrayBuffer(1+c+b),e=new Int8Array(d),f=0;e[f++]=2|UNSUBSCRIBE;do digit=Math.floor(b%128),b=Math.floor(b/128),b>0&&(digit|=128),e[f++]=digit;while(b>0);e[f++]=0,e[f++]=this.generate_mid(),e[f++]=0,e[f++]=a.length;for(var g=0;g<a.length;g++)e[f++]=a.charCodeAt(g);1==this.ws.readyState?this.ws.send(d):this.queue(d)},subscribe:function(a,b){if(0!=b)return 1;var c=4+a.length+1,d=this.get_remaining_count(c),e=new ArrayBuffer(1+d+c),f=new Int8Array(e),g=0;f[g++]=2|SUBSCRIBE;do digit=Math.floor(c%128),c=Math.floor(c/128),c>0&&(digit|=128),f[g++]=digit;while(c>0);f[g++]=0,f[g++]=this.generate_mid(),f[g++]=0,f[g++]=a.length;for(var h=0;h<a.length;h++)f[g++]=a.charCodeAt(h);f[g++]=b,1==this.ws.readyState?this.ws.send(e):this.queue(e)},publish:function(a,b,c,d){if(0!=c)return 1;var e=2+a.length+b.length,f=this.get_remaining_count(e),g=new ArrayBuffer(1+f+e),h=new Int8Array(g),i=0;d=d?1:0,h[i++]=PUBLISH|c<<1|d;do digit=Math.floor(e%128),e=Math.floor(e/128),e>0&&(digit|=128),h[i++]=digit;while(e>0);h[i++]=0,h[i++]=a.length;for(var j=0;j<a.length;j++)h[i++]=a.charCodeAt(j);for(var j=0;j<b.length;j++)h[i++]=b.charCodeAt(j);1==this.ws.readyState?this.ws.send(g):this.queue(g)}};